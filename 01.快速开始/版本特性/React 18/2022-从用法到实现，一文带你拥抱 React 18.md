> [åŸæ–‡åœ°å€](https://juejin.cn/post/7095185674151821348#heading-14)

# ä»ç”¨æ³•åˆ°å®ç°ï¼Œä¸€æ–‡å¸¦ä½ æ‹¥æŠ± React 18

# å‰è¨€

React å›¢é˜Ÿåœ¨æ‰“é€ å¿«é€Ÿå“åº”çš„ç”¨æˆ·ç•Œé¢ä¸Šå…¶å®ä¸€ç›´åœ¨æ¢ç´¢ï¼Œæœ€ç»ˆç»™å‡ºçš„ç­”æ¡ˆå°±æ˜¯æ•´åˆäº†äººæœºäº¤äº’ç ”ç©¶æˆæœï¼ˆåæ–‡ä¼šå…·ä½“ä»‹ç»ï¼‰çš„ Concurrent Renderingã€‚

ç„¶è€Œå› ä¸ºè¿™èƒŒåçš„å¤æ‚æ€§ã€ç¨³å®šæ€§ã€å…¼å®¹æ€§ç­‰é—®é¢˜ï¼Œä» 16 ç‰ˆæœ¬çš„ Async Mode å¼€å§‹å°±åœ¨ä¸æ–­æ‰“ç£¨ï¼Œè€—æ—¶å¤šå¹´ï¼Œç»å†äº† 17 ç‰ˆæœ¬è¿‡æ¸¡ï¼Œæœ€ç»ˆä¼´éšç€ 18 ç‰ˆæœ¬æ­£å¼ä¸Šçº¿ï¼Œè¿™ä¸€ç‰ˆæœ¬ä¸­å¼€å‘è€…å¯ä»¥å®Œå…¨å¹³æ»‘çš„å¼€å¯å¹¶å‘ç‰¹æ€§ã€‚

ä»Šå¤©å¸Œæœ›é€šè¿‡è¿™ç¯‡æ–‡ç« å¸¦å¤§å®¶ä¸€èµ·æ·±å…¥äº†è§£ä¸€ä¸‹ React 18 ä¸­çš„æ–°ç‰¹æ€§ã€æ–°èƒ½åŠ›ã€‚

# Concurrent Rendering

Concurrency æ˜¯ React 18 çš„å…³é”®è¯ï¼Œå¯ä»¥ç†è§£æˆæ˜¯ä¸€ç§èƒŒåçš„æœºåˆ¶ï¼Œä¿è¯ React èƒ½å¤ŸåŒæ—¶å‡†å¤‡å¤šå¥— UIã€‚å…·ä½“åˆ°è¡¨ç°ä¸ŠåŒºåˆ«äºä»¥å¾€çš„æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯æ¸²æŸ“æ˜¯å¯ä¸­æ–­çš„ã€‚è¿™æ„å‘³ç€å½“ä½ çš„åº”ç”¨æ­£åœ¨è¿›è¡Œå¤æ‚æ›´æ–°çš„æ—¶å€™ï¼Œä»ç„¶å¯ä»¥ä¸é¡µé¢è¿›è¡Œäº¤äº’ï¼Œä¿è¯ä¸€ä¸ªæµç•…çš„ç”¨æˆ·ä½“éªŒã€‚æ—¢ç„¶æ˜¯ä¸€ç§èƒŒåçš„æœºåˆ¶ï¼Œå®é™…ä¸Šå¼€å‘è€…å¹¶ééœ€è¦å…ˆå­¦ä¹ å¹¶å‘æ¸²æŸ“æ‰èƒ½ä½¿ç”¨ React18ï¼Œä½†æ˜¯èƒ½å¤ŸæŒæ¡å¹¶å‘æ¸²æŸ“å¯¹äºæ–°ç‰¹æ€§çš„ç†è§£æœ‰éå¸¸å¤§çš„ä½œç”¨ã€‚

æ ¸å¿ƒå®ç°æ˜¯é€šè¿‡ç»„ä»¶ä½œä¸ºä¸€ä¸ªåŸºæœ¬çš„å·¥ä½œå•å…ƒå°†ä¸€ä¸ªå¤§çš„æ›´æ–°ä»»åŠ¡è¿›è¡Œæ‹†åˆ†ï¼Œç„¶åä»¥æ—¶é—´åˆ‡ç‰‡çš„æ–¹å¼ï¼Œåˆ†å¸ƒåœ¨ä¸åŒçš„æ—¶é—´ç‰‡æ¥æ‰§è¡Œï¼Œæ¯ä¸ªæ—¶é—´ç‰‡æ‰§è¡Œå®Œæˆåéƒ½ä¼šä¸»åŠ¨é‡Šæ”¾æ§åˆ¶æƒï¼Œä½¿å¾—æµè§ˆå™¨èƒ½å¤Ÿå¤„ç†å…¶å®ƒç”¨æˆ·äº‹ä»¶ã€‚è€Œå…·ä½“æ—¶é—´ç‰‡ä¸Šæ‰§è¡Œå“ªä¸ªä»»åŠ¡æ˜¯ç”±ä»»åŠ¡ä¸Šçš„ç›¸å…³ä¼˜å…ˆçº§å†³å®šçš„ï¼Œå½“é«˜ä¼˜å…ˆçº§çš„æ›´æ–°åˆ°æ¥æ—¶ï¼Œä¼šä¸­æ–­æ—§çš„æ›´æ–°ï¼Œä¼˜å…ˆæ‰§è¡Œé«˜ä¼˜å…ˆçº§æ›´æ–°ï¼Œå¾…å®Œæˆåç»§ç»­æ‰§è¡Œä½ä¼˜å…ˆçº§æ›´æ–°ï¼Œå› æ­¤åœ¨ä¸€ä¸ªæ—¶é—´æ®µå†…ï¼Œæˆ‘ä»¬çœ‹ React åœ¨å¹¶å‘çš„æ‰§è¡Œå¤šä¸ªæ¸²æŸ“ä»»åŠ¡ã€‚

## Auto Batching

é¦–å…ˆæ‰¹å¤„ç†æ˜¯æŒ‡ React å°†å¤šæ¬¡çŠ¶æ€æ›´æ–°åˆå¹¶æˆä¸€æ¬¡é‡æ¸²æŸ“æ¥æå‡æ€§èƒ½ï¼Œæ—©åœ¨ 16 çš„ç‰ˆæœ¬ä¸­å…¶å®å°±å·²ç»åŒ…å«äº†æ‰¹å¤„ç†èƒ½åŠ›ï¼Œå¦‚ä¸‹é¢çš„ä¾‹å­ï¼š

```js
function App() {
  const [count, setCount] = useState(0);

  const [flag, setFlag] = useState(false);

  function handleClick() {
    setCount((c) => c + 1); // Does not re-render yet

    setFlag((f) => !f); // Does not re-render yet

    // React will only re-render once at the end (that's batching!)
  }

  return (
    <div>
      <button onClick={handleClick}>Next</button>

      <h1 style={{ color: flag ? "blue" : "black" }}>{count}</h1>
    </div>
  );
}
```

ç„¶è€Œå¦‚æœæ›´æ–°å‘ç”Ÿåœ¨ timeouts, promises, native event handlers ç­‰é React events äº‹ä»¶ä¸­ï¼ŒReact 18 ä¹‹å‰çš„ç‰ˆæœ¬é»˜è®¤éƒ½ä¸ä¼šè¿›è¡Œåˆå¹¶ï¼š

```js
function handleClick() {
  fetchSomething().then(() => {
    // React 17 and earlier does NOT batch these because

    // they run *after* the event in a callback, not *during* it

    setCount((c) => c + 1); // Causes a re-render

    setFlag((f) => !f); // Causes a re-render
  });
}
```

åœ¨ React 18 ä¸­ï¼Œä¸ä¼šæ›´æ–°å‘ç”Ÿåœ¨å“ªé‡Œï¼Œéƒ½ä¼šè‡ªåŠ¨åˆå¹¶ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ç§è‡ªåŠ¨åˆå¹¶æ˜¯å®Œå…¨å®‰å…¨ä¸”æ— æ„ŸçŸ¥çš„ï¼Œä½†æ˜¯ä»ç„¶æœ‰ä¸€äº› bad case éœ€è¦ç‰¹æ®Šå¤„ç†ä»¥ä¿æŒå‘å‰å…¼å®¹ï¼Œæ¯”å¦‚ä¸‹é¢çš„ caseï¼š

```js
handleClick = () => {
  setTimeout(() => {
    this.setState(({ count }) => ({ count: count + 1 }));

    // { count: 1, flag: false } before 18

    // { count: 0, flag: false } in 18

    console.log(this.state);

    this.setState(({ flag }) => ({ flag: !flag }));
  });
};
```

åœ¨ 18 ä¹‹å‰ï¼Œç”±äºæ›´æ–°ä¼šåŒæ­¥æ‰§è¡Œï¼Œå› æ­¤æˆ‘ä»¬èƒ½å¤Ÿè·å¾—ä¸­é—´çŠ¶æ€ã€‚ç„¶è€Œåœ¨ 18 ä¸­ï¼Œå³ä½¿æ˜¯ setTimeout ä¸­çš„æ›´æ–°ä¹Ÿä¼šè‡ªåŠ¨åˆå¹¶ï¼Œå¹¶åœ¨ next tick ä¸­åˆå¹¶æ‰§è¡Œï¼Œæ‰“å°çš„çŠ¶æ€ä¸ºåˆå§‹åŒ–çŠ¶æ€ï¼Œä»è€Œå‰åä¸ä¸€è‡´ã€‚

é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ React 18 ä¸­æä¾›çš„ ReactDOM.flushSync æ¥ä¿æŒå‘å‰å…¼å®¹ã€‚

```js
handleClick = () => {
  setTimeout(() => {
    ReactDOM.flushSync(() => {
      this.setState(({ count }) => ({ count: count + 1 }));
    });

    // { count: 1, flag: false }

    console.log(this.state);

    this.setState(({ flag }) => ({ flag: !flag }));
  });
};
```

### Deep dive

è‡ªåŠ¨æ‰¹å¤„ç†å®ç°çš„å…³é”®åœ¨äº React18 ä¸­æ›´æ–°æ˜¯åŸºäºä¼˜å…ˆçº§çš„ï¼Œæˆ‘ä»¬ç»“åˆä¸‹é¢æºç çœ‹ä¸€ä¸‹ï¼Œè¯¥æ–¹æ³•æ˜¯ 18 ä¸­æ¯ä¸€æ¬¡æ›´æ–°è°ƒåº¦çš„å¿…ç»ä¹‹è·¯ï¼Œæ‰¹å¤„ç†çš„å®ç°çš„æ ¸å¿ƒåœ¨äºå½“ç›¸åŒä¼˜å…ˆçº§çš„æ›´æ–°å‘ç”Ÿæ—¶ï¼Œå¹¶ä¸ä¼šç”Ÿæˆæ–°çš„ä»»åŠ¡ï¼Œè€Œæ˜¯å¤ç”¨ä¸Šä¸€æ¬¡çš„ä»»åŠ¡ï¼Œä»è€Œå®ç°åˆå¹¶ã€‚

```js
function ensureRootIsScheduled(root: FiberRoot, currentTime: number) {
  // Determine the next lanes to work on, and their priority.

  const nextLanes = getNextLanes(root);

  // We use the highest priority lane to represent the priority of the callback.

  const newCallbackPriority = getHighestPriorityLane(nextLanes);

  // Check if there's an existing task. We may be able to reuse it.

  const existingCallbackPriority = root.callbackPriority;

  if (existingCallbackPriority === newCallbackPriority) {
    // The priority hasn't changed. We can reuse the existing task. Exit.

    return;
  }

  // Cancel the existing callback.

  cancelCallback(existingCallbackNode);

  // schedule a new one.

  if (newCallbackPriority === SyncLane) {
    scheduleSyncCallback(performSyncWorkOnRoot.bind(null, root));
  } else {
    newCallbackNode = scheduleCallback(
      schedulerPriorityLevel,

      performConcurrentWorkOnRoot.bind(null, root)
    );
  }
}
```

å¦‚æœç†è§£äº†è¿™ä¸ªï¼Œé‚£ä¸ª FlushSync çš„å®ç°ä¹Ÿå°±æ¯”è¾ƒç®€å•äº†ï¼Œæ— éæ˜¯å°†å†…éƒ¨æ›´æ–°çš„ä¼˜å…ˆçº§å¼ºåˆ¶æŒ‡å®šä¸º SyncLaneï¼Œå³æŒ‡å®šä¸ºåŒæ­¥ä¼˜å…ˆçº§ï¼Œå…·ä½“æ•ˆæœå°±æ˜¯æ¯ä¸€æ¬¡æ›´æ–°æ—¶éƒ½ä¼šåŒæ­¥çš„æ‰§è¡Œæ¸²æŸ“ã€‚

```js
export function flushSync(fn) {
  try {
    // DiscreteEventPriority === SyncLane

    setCurrentUpdatePriority(DiscreteEventPriority);

    fn && fn();
  } finally {
    setCurrentUpdatePriority(previousPriority);
  }
}
```

## Transition

transition æ˜¯ 18 ç‰ˆæœ¬ä¸­æ–°æå‡ºçš„æ¦‚å¿µï¼Œä¹Ÿæ˜¯æœ€èƒ½ä½“ç°å¹¶å‘æ¸²æŸ“ä¼˜åŠ¿çš„ä¸Šå±‚åº”ç”¨ã€‚å…ˆçœ‹ä¸€ä¸ªä¾‹å­ï¼Œå½“æ»‘å—æ»‘åŠ¨æ—¶ï¼Œä¸‹æ–¹çš„å›¾è¡¨ä¼šä¸€èµ·æ›´æ–°ï¼Œç„¶è€Œå›¾è¡¨æ›´æ–°æ˜¯ä¸€ä¸ª CPU å¯†é›†å‹æ“ä½œï¼Œæ¯”è¾ƒè€—æ—¶ã€‚ç”±äºé˜»å¡äº†æ¸²æŸ“å¯¼è‡´é¡µé¢å¤±å»å“åº”ï¼Œç”¨æˆ·èƒ½å¤Ÿéå¸¸æ˜æ˜¾çš„æ„Ÿå—åˆ°å¡é¡¿ã€‚

![](https://assets.ng-tech.icu/gif/14f828dc58f84e729acf6343bfcc7d7c%7Etplv-k3u1fbpfcp-zoom-in-crop-mark_4536_0_0_0.webp)

å®é™…ä¸Šï¼Œå½“æˆ‘ä»¬æ‹–åŠ¨æ»‘å—çš„æ—¶å€™ï¼Œéœ€è¦åšä¸¤æ¬¡æ›´æ–°ï¼š

```js
// Urgent: Show what was typed
setSliderValue(input);

// Not urgent: Show the results
setGraphValue(input);
```

ä¸€ä¸ªæ˜¯æ¯”è¾ƒç´§æ€¥éœ€è¦ç«‹åˆ»ååº”åœ¨ç•Œé¢ä¸Šï¼Œå¦åˆ™ç”¨æˆ·ä¼šè§‰å¾—é‡åˆ°äº† bugã€‚è€Œå¦ä¸€ä¸ªå¯¹äºç”¨æˆ·è€Œè¨€ï¼ŒæŸ¥è¯¢ç»“æœçš„æ˜¾ç¤ºï¼Œå³ä½¿å­˜åœ¨ä¸€äº›å»¶è¿Ÿä¹Ÿæ˜¯å¯æ¥å—çš„ã€‚è¿™ç§æ¥å—ç¨‹åº¦æ­£æ˜¯äººæœºç ”ç©¶çš„æˆæœï¼š

> we know from research that interactions like hover and text input need to be handled within a very short period of time, while clicks and page transitions can wait a little longer without feeling laggy. â€”â€” Putting Research into Production

åœ¨ React 18 ä¹‹å‰æ‰€æœ‰çš„æ›´æ–°éƒ½æ˜¯ä¸€æ ·çš„ï¼Œç¼ºä¹ä¸€ç§æœºåˆ¶ï¼Œæ¥å£°æ˜è¿™ç§ä¸åŒç´§æ€¥ç¨‹åº¦çš„æ›´æ–°ï¼ŒTransition å°±ç”¨æ¥è§£å†³è¿™ç§é—®é¢˜ã€‚React 18 ä¸­æä¾›äº† startTransition æ¥è®©å¼€å‘è€…æ˜¾ç¤ºçš„å£°æ˜éç´§æ€¥æ›´æ–°ã€‚transition å–åçš„å«ä¹‰æ˜¯ï¼ŒReact ä¸­ä»å¼€å‘è€…è§’åº¦å°†çŠ¶æ€æ›´æ–°åˆ†æˆäº†ä¸¤ç±»ï¼š

- ä¸€ç±»æ˜¯ç”¨æˆ·è¾“å…¥ã€ç‚¹å‡»ç­‰ç´§æ€¥æ›´æ–°ï¼Œå¦ä¸€ç±»æ˜¯å°† UI ä»ä¸€ä¸ªè§†å›¾è½¬å˜æˆå¦å¤–ä¸€ä¸ª
- transition ä¸­å¯¹åº”çš„æ›´æ–°ç±»å‹ä¸ºç¬¬äºŒç§ã€‚

### startTransition

é€šè¿‡ starTransition å¯ä»¥æ ‡è®°éç´§æ€¥çš„æ›´æ–°ï¼Œå…·ä½“çš„æ‰§è¡Œæ—¶æœºä¼šæ ¹æ®å½“å‰ç©ºé—²ç¨‹åº¦åŠ¨æ€å†³å®šã€‚

```js
import { startTransition } from "react";

// Urgent
setSliderValue(input);

// Mark any state updates inside as transitions
startTransition(() => {
  // Transition: Show the results

  setGraphValue(input);
});
```

### useTransition

å¯ä»¥é€šè¿‡ useTransition ä¸­çš„ pending æ¥ç¡®å®šå½“å‰æ›´æ–°çš„æ‰§è¡ŒçŠ¶æ€ï¼Œå¹¶æ¸²æŸ“ä¸€äº› loadingï¼š

```js
import { useTransition } from "react";

const [isPending, startTransition] = useTransition();

return isPending && <Spinner />;
```

ç„¶è€Œå³ä½¿æˆ‘ä»¬æ ¹æ® isPending è®¾ç½®äº† loading ç•Œé¢ï¼Œè¿™ä¸ª loading ä¹Ÿå¹¶éä¸€å®šä¼šå‡ºç°ï¼Œæ ¹æ®äººæœºäº¤äº’çš„ç ”ç©¶æˆæœï¼Œè¿‡å¤šçš„æ˜¾ç¤ºä¸€äº›ä¸­é—´è§†å›¾ä¼šè®©ç”¨æˆ·æ„Ÿè§‰å¾—æ›´æ…¢ï¼Œå› æ­¤åœ¨æ€§èƒ½æ¯”è¾ƒå¥½æ—¶ï¼Œtransition ä¸­çš„æ›´æ–°å¾ˆå¿«æ‰§è¡Œï¼Œloading ç•Œé¢å°†ä¸ä¼šå±•ç¤ºï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šå‡ºç°â€œé—ªä¸€ä¸‹â€çš„æƒ…å†µï¼Œæ¥æå‡ç”¨æˆ·ä½“éªŒï¼š

> research shows that displaying too many intermediate loading states when transitioning between screens makes a transition feel slower. â€”â€” Putting Research into Production

æˆ‘ä»¬å†æ¥æ„Ÿå—ä¸€ä¸‹ä½¿ç”¨äº† transition ä¹‹åçš„æ•ˆæœï¼š

![](https://assets.ng-tech.icu/gif/82e2121398404324a61f9d215ff1b348%7Etplv-k3u1fbpfcp-zoom-in-crop-mark_4536_0_0_0.webp)

åº”è¯¥å¯ä»¥æ˜æ˜¾çš„æ„Ÿå—åˆ°ï¼Œè™½ç„¶å›¾è¡¨çš„æ›´æ–°è¿˜æ˜¯ä¼šæœ‰äº›å»¶è¿Ÿï¼Œä½†æ˜¯æ•´ä½“çš„ç”¨æˆ·ä½“éªŒç›¸å¯¹ä¹‹å‰æ˜¯éå¸¸å¥½çš„ã€‚

### ä¸ä»¥å¾€è§£å†³æ–¹æ¡ˆçš„çš„åŒºåˆ«

è™½ç„¶åœ¨ 18 ç‰ˆæœ¬ä¹‹å‰ React æœ¬èº«å¹¶æ²¡æœ‰æä¾›å£°æ˜æ›´æ–°ä¼˜å…ˆçº§çš„æ–¹å¼ï¼Œä½†æ˜¯æˆ‘ä»¬ä»ç„¶å¯ä»¥é€šè¿‡ JS æ¥ä¼˜åŒ–è¿™ä¸€é—®é¢˜ï¼Œæ¯”å¦‚é€šè¿‡ setTimeout / throttle / debounce

```js
setSliderValue(input);

setTimeout(() => {
  setGraphValue(input);
}, 0);
```

ä¸ä¹‹ç›¸æ¯”ï¼Œ`transition`çš„åŒºåˆ«ä¸»è¦è¡¨ç°åœ¨:

- **æ‰§è¡Œæ—¶æœº**ï¼Œ`setTimout/throttle/debounce` å‡ä¸ºå¼‚æ­¥æ‰§è¡Œï¼Œè€Œ`transition`ä¸ºåŒæ­¥æ‰§è¡Œï¼Œå› æ­¤ä¼šæ¯”ä»–ä»¬æ›´æ—©çš„è§¦å‘æ›´æ–°è°ƒåº¦ï¼Œåœ¨æ€§èƒ½è¾ƒå¥½æ—¶å¯èƒ½åœ¨åŒä¸€å¸§å®Œæˆæ›´æ–°ï¼Œè€Œè¿™ç§æƒ…å†µåœ¨æ¯”å¦‚`throttle`ä¸­è¢«å¼ºåˆ¶æ‹‰å¤§ï¼Œæ¯”å¦‚ 100ms
- **äº¤äº’ä½“éªŒ**ï¼Œä¸ç®¡æ˜¯å»¶è¿Ÿè¿˜æ˜¯å‡é¢‘ï¼Œå½“çœŸæ­£è§¦å‘æ›´æ–°ï¼Œå¦‚æœæ¸²æŸ“æ—¶é—´æ¯”è¾ƒä¹…ï¼Œä¾ç„¶ä¼šå‘ç”Ÿç•Œé¢å¡é¡¿ï¼Œè€Œé€šè¿‡`transition`è§¦å‘çš„æ›´æ–°å¹¶ä¸ä¼šé˜»å¡ç”¨æˆ·ç•Œé¢ï¼Œèƒ½å¤Ÿä¸€ç›´ä¿æŒå“åº”
- **ç²¾ç¡®æ§åˆ¶**ï¼Œéœ€è¦é¢å¤–å®ç° loading æ§åˆ¶ï¼Œè€Œä¸”å¾€å¾€ä¸å¤Ÿç²¾ç¡®ï¼Œç°åœ¨`transition`å†…éƒ¨ä¼šä¸ºæˆ‘ä»¬è‡ªåŠ¨ç»´æŠ¤è¿™ä¸ª loading çŠ¶æ€ï¼Œå¹¶ä¸”è¶³å¤Ÿç²¾ç¡®

### Deep dive

æˆ‘ä»¬ç»“åˆæºç çœ‹ä¸€ä¸‹ transition æ˜¯å¦‚ä½•å®ç°çš„ï¼Œå¯ä»¥çœ‹åˆ°æœ¬èº«çš„å®ç°å¹¶ä¸å¤æ‚ï¼Œåœ¨ startTransition å†…éƒ¨æ—¶ä¼šå¼€å¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå…¶åæ‰§è¡Œçš„æ›´æ–°éƒ½ä¼šæ ¹æ®è¯¥å¼€å…³é»˜è®¤å¼€å¯ transition ä¼˜å…ˆçº§ï¼Œè€Œè¿™ä¸ªä¼˜å…ˆçº§è¦æ¯”ä¸€èˆ¬çš„ä¼˜å…ˆçº§æ›´ä½ä¸€äº›ï¼Œå› æ­¤æ‰§è¡Œæ—¶é—´è¦æ¯”æ™®é€šæ›´æ–°æ™šï¼ŒåŒæ—¶å³ä½¿æ›´æ–°å‘ç”Ÿæ—¶ï¼Œä¹Ÿå¯ä»¥è¢«é«˜ä¼˜å…ˆçº§çš„æ›´æ–°æ‰“æ–­ï¼Œä»è€Œä¸é˜»å¡ç”¨æˆ·æ¸²æŸ“ã€‚

```js
function startTransition(setPending, callback, options) {
  // ...

  const prevTransition = ReactCurrentBatchConfig.transition;

  // Tag We are inside transition

  ReactCurrentBatchConfig.transition = {};

  callback();

  // Recovery

  ReactCurrentBatchConfig.transition = prevTransition;
}

// Request priority when fiber update

export function requestUpdateLane(fiber: Fiber) {
  // ...

  // requestCurrentTransition => ReactCurrentBatchConfig.transition

  const isTransition = requestCurrentTransition() !== null;

  if (isTransition) {
    return claimNextTransitionLane();
  }

  // ...
}
```

useTransition çš„å®ç°æœ¬è´¨ä¸Šå°±æ˜¯é€šè¿‡ useState+startTransitionï¼Œå®ç°å…³é”®ç‚¹åœ¨äºä¸¤æ¬¡ setPendingï¼Œè™½ç„¶æ˜¯åŒæ­¥æ‰§è¡Œï¼Œä½†ä¸¤è€…çš„åŒºåˆ«åœ¨äºç¬¬ä¸€æ¬¡çš„ setPending ä¸ºæ™®é€šä¼˜å…ˆçº§ï¼Œè€Œç¬¬äºŒæ¬¡å› ä¸ºå…¨å±€å¼€å…³æ‰“å¼€ï¼Œä¼šè¢«æˆäºˆ transition ä¼˜å…ˆçº§ï¼Œä¸ callback ä¸­çš„æ›´æ–°è‡ªåŠ¨åˆå¹¶ï¼Œå› æ­¤ pending ä¼šé¦–å…ˆè¢«ç½®æˆ trueï¼Œåœ¨ transition æ›´æ–°å®Œæˆæ—¶ï¼Œé‡ç½®ä¸º falseï¼š

```js
function mountTransition() {
  const [isPending, setPending] = mountState(false);

  const start = (callback) => {
    setPending(true);

    const prevTransition = ReactCurrentBatchConfig.transition;

    // Tag We are inside transition

    ReactCurrentBatchConfig.transition = {};

    setPending(false);

    callback();

    // Recovery

    ReactCurrentBatchConfig.transition = prevTransition;
  };

  return [isPending, start];
}
```

å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼ŒğŸ¤” ä¸‹é¢è¿™ä¸¤ç§æ–¹å¼æœ‰ä»€ä¹ˆåŒºåˆ«å—

```js
startTransition(() => {
  setValue1(value);

  setValue2(value);
});

startTransition(() => {
  setValue1(value);
});

startTransition(() => {
  setValue2(value);
});
```

ä»æ‰§è¡Œçš„æ•ˆæœçœ‹ï¼Œç”±äºç›®å‰æ‰€æœ‰çš„ transition ä¸­çš„æ›´æ–°ä¼šè¢«æ ‡è®°æˆåŒæ ·çš„ä¼˜å…ˆçº§ï¼ŒåŒæ ·çš„ä¼˜å…ˆçº§æ„å‘³ç€ä¼šåœ¨åŒä¸€æ¬¡è°ƒåº¦ä¸­ä¸€èµ·æ‰§è¡Œï¼Œæ‰€ä»¥è¿™ä¸¤ç§ç”¨æ³•ç›®å‰æ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚

ä½†æ˜¯ä»åˆç†æ€§çš„è§’åº¦ï¼Œä¸¤ä¸ªå®Œå…¨ç‹¬ç«‹çš„ transition åº”è¯¥æ˜¯å¯ä»¥ç‹¬ç«‹å»æ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯ä¼šè¢«èµ‹äºˆæ›´ç»†ç²’åº¦çš„ä¼˜å…ˆçº§ï¼Œè¿™ä¹Ÿæ˜¯ transition åç»­æ›´æ–°çš„æ–¹å‘ã€‚è€Œå¦‚ä½•è®¤ä¸ºå®Œå…¨ç‹¬ç«‹ï¼Œå¹¶ä¸æ˜¯ä»…ä»…ä½¿ç”¨äº†ä¸¤ä¸ªå•ç‹¬ startTransitionï¼ŒReact ä¼šä»å†…éƒ¨è‡ªåŠ¨è¿›è¡Œæ£€æµ‹æ›´æ–°çš„çŠ¶æ€æ˜¯å¦æœ‰ä¾èµ–ï¼Œå› ä¸ºå¦‚æœä¸¤ä¸ªæ›´æ–°æœ‰é‡å çš„è¯ï¼Œå®é™…ä¸Šè¿›è¡Œæ‹†åˆ†ä¼šæœ‰æµªè´¹ï¼Œæ¯”å¦‚ä¸€ä¸ªä¸‹æ‹‰æ¡†ï¼Œæˆ‘åˆ‡æ¢äº†å¾ˆå¤šæ¬¡ä¹‹åï¼Œä¸­é—´çŠ¶æ€å†å±•ç¤ºå¹¶æ²¡æœ‰æ„ä¹‰äº†ï¼Œåªéœ€è¦æ¸²æŸ“æœ€ç»ˆçŠ¶æ€å°±å¯ä»¥äº†ã€‚

### useDeferredValue

ç°åœ¨æˆ‘ä»¬çŸ¥é“æ›´æ–°å‘ç”Ÿæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ startTransition æ¥æ ‡è®°ä½ä¼˜å…ˆçš„æ›´æ–°ï¼š

```js
import { startTransition } from "react";

const Comp = () => {
  const handleChange = () => {
    setSliderValue(input);

    startTransition(() => {
      setGraphValue(input);
    });
  };

  // ...
};
```

é‚£å¦‚æœæ›´æ–°è§¦å‘çš„å®é™…æˆ‘ä»¬å¹¶ä¸çŸ¥é“ï¼Œæ¯”å¦‚ä» parent compnent / other hooks / å¤šä¸ª handler / URL æ”¹å˜ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒReact æä¾›äº†å¦ä¸€ä¸ª hook updateDeferredValue æ¥æ ‡è®°éç´§æ€¥æ›´æ–°ã€‚

```js
import { useDeferredValue } from "react";

const Comp = (input) => {
  const graphValue = useDeferredValue(input);

  // ...updating depends on graphValue
};
```

ä¸Šæ–¹ä»£ç çš„å…·ä½“æ•ˆæœæ˜¯å½“ input æ”¹å˜æ—¶ï¼Œè¿”å›çš„ graphValue å¹¶ä¸ä¼šç«‹å³æ”¹å˜ï¼Œä¼šé¦–å…ˆè¿”å›ä¸Šä¸€æ¬¡çš„ input å€¼ï¼Œä¸å­˜åœ¨æ›´ç´§æ€¥çš„æ›´æ–°æ—¶ï¼Œæ‰ä¼šå˜æˆæœ€æ–°çš„ inputï¼Œå› æ­¤å¯ä»¥é€šè¿‡ graphValue æ˜¯å¦æ”¹å˜æ¥è¿›è¡Œä¸€äº›ä½ä¼˜å…ˆçº§çš„æ›´æ–°ï¼Œæ‰€ä»¥æ•ˆæœæ˜¯åŸºæœ¬ä¸Šæ˜¯å’Œ transition æ˜¯ä¸€è‡´çš„ã€‚

è€Œå®ç°ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®å°±æ˜¯å°è£…äº† useState + useEffect + startTransitionï¼Œè°ƒåº¦ä¸€ä¸ª Effect å‘èµ·ä¸€ä¸ª startTransition æ¥æ›´æ–°å…·ä½“çš„ value

```js
function updateDeferredValue(value) {
  const [prevValue, setValue] = updateState(value);

  updateEffect(() => {
    const prevTransition = ReactCurrentBatchConfig.transition;

    ReactCurrentBatchConfig.transition = {};

    setValue(value);

    ReactCurrentBatchConfig.transition = prevTransition;
  }, [value]);

  return prevValue;
}
```

ä½†æ˜¯ä¸Šé¢çš„å®ç°æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ¯”å¦‚å½“æ¥å—çš„ value å¹¶éä¸€ä¸ª memorizedValueï¼Œå³æ¯æ¬¡éƒ½æ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼ŒstartTransition æ›´æ–°å‘ç”Ÿçš„æ—¶å€™ä¼šå†æ¬¡è§¦å‘è¿™ä¸ªæ–¹æ³•ï¼Œåˆä¼šå‘èµ·ä¸€æ¬¡æ–°çš„è°ƒåº¦ï¼Œä»è€Œé€ æˆæ­»å¾ªç¯ã€‚å› æ­¤å‰ä¸ä¹…ï¼Œå¯¹è¿™ä¸ªè¿™ä¸ª hook çš„å®ç°åšäº†ä¸€ç‰ˆæ›´æ–° PRï¼Œæ–°çš„å®ç°å¦‚ä¸‹ï¼š

```js
function updateDeferredValue(value) {
  const shouldDeferValue = !includesOnlyNonUrgentLanes(renderLanes);

  if (shouldDeferValue) {
    // This is an urgent update. If the value has changed, keep using the

    // previous value and spawn a deferred render to update it later.

    const prevValue = currentHook.memoizedState;

    if (!is(value, prevValue)) {
      // Mark an Transition Update

      const deferredLane = claimNextTransitionLane();

      currentlyRenderingFiber.lanes = mergeLanes(
        currentlyRenderingFiber.lanes,

        deferredLane
      );
    }

    return prevValue;
  }

  hook.memoizedState = value;

  return value;
}
```

å¯ä»¥çœ‹åˆ°æ–°çš„å®ç°ä¸ä¼šä¾èµ– effectï¼Œè€Œæ˜¯æ ¹æ®å½“å‰æ›´æ–°çš„ä¼˜å…ˆçº§æ¥ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªç´§æ€¥æ›´æ–°åˆ™ç›´æ¥è¿”å› prevValueï¼Œå¹¶ä¸”åœ¨å½“å‰ fiber ä¸­æ ‡è®°ä¸€ä¸ª transition æ›´æ–°ã€‚å½“éç´§æ€¥æ›´æ–°å‘ç”Ÿæ—¶ï¼Œç›´æ¥è¿”å›æœ€æ–°çš„å€¼ã€‚

# Upgrade

## Upgrade Root API

åŒæ—¶è¿˜éœ€è¦å‡çº§ä¸€ä¸‹ root api æ‰èƒ½ä½¿ç”¨æœ€æ–°çš„å¹¶å‘ç‰¹æ€§ã€‚

- Legacy Root API

```typescript
import ReactDOM from "react-dom";

import App from "App";

const container = document.getElementById("app");

// Initial render.

ReactDOM.render(<App />, container);
```

- New Root API

```typescript
import * as ReactDOMClient from "react-dom/client";

import App from "App";

const container = document.getElementById("app");

// Create a root.

const root = ReactDOMClient.createRoot(container);

// Initial render: Render an element to the root.

root.render(<App />);
```

ä¸ºäº†ä»£ç çš„å¹³æ»‘å‡çº§ï¼Œä¸¤ç§æ–¹å¼éƒ½å°†ä¼šä¿ç•™ï¼Œä¸ç„¶æ•ˆæœä¼šæ˜¯ï¼Œå‡çº§å®Œ 18 çš„åŒ…å‘ç°è¿è¡Œç›´æ¥å´©æºƒ= =ï¼Œä½†æ˜¯ä½¿ç”¨æ—§çš„ render æ— æ³•ä½¿ç”¨æ–°ç‰¹æ€§ä¸”ä¼šè·å¾— warningï¼Œå¼•å¯¼è¿›è¡Œ root å‡çº§

æ–°æ—§ RootAPI è¿˜æœ‰ä¸€ç‚¹æ”¹åŠ¨æ˜¯ï¼ŒåŸå…ˆ render ä¼šåŒ…å«ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå›è°ƒï¼Œæ–°çš„ api ç§»é™¤äº†

```typescript
import * as ReactDOM from 'react-dom';

import App from 'App';

const container = document.getElementById('app');

ReactDOM.render(container, <App tab="home" />, function() {

  // Called after inital render or any update.

  console.log('rendered').

});

```

ä½†æ˜¯å¯ä»¥é€šè¿‡å…¶å®ƒæ–¹å¼æ¥ä»£æ›¿ï¼Œæ¯”å¦‚ï¼š

- é€šè¿‡ ref

```js
import * as ReactDOMClient from "react-dom/client";

function App({ callback }) {
  // Callback will be called when the div is first created.

  return (
    <div ref={callback}>
      <h1>Hello World</h1>
    </div>
  );
}

const rootElement = document.getElementById("root");

const root = ReactDOMClient.createRoot(rootElement);

root.render(<App callback={() => console.log("renderered")} />);
```

- é€šè¿‡ useEffect

```js
import { useEffect } from "react";

import * as ReactDOMClient from "react-dom/client";

function App() {
  useEffect(() => {
    // Callback will be called when the div is first created.

    console.log("renderered");
  }, []);

  return (
    <div>
      <h1>Hello World</h1>
    </div>
  );
}

const rootElement = document.getElementById("root");

const root = ReactDOMClient.createRoot(rootElement);

root.render(<App />);
```

ä¸¤è€…çš„åŒºåˆ«åœ¨äº

- Ref ä¼šåœ¨åº”ç”¨æ·»åŠ åˆ° dom ä¹‹ååŒæ­¥çš„æ‰§è¡Œ
- Effects ç”±äºæœ¬èº«çš„å®ç°æ˜¯å¼‚æ­¥çš„ï¼Œä¼šæœ‰ä¸€ä¸ªå°çš„å»¶è¿Ÿ

ä½¿ç”¨å“ªç§æ–¹å¼å–å†³äºä½ å…·ä½“çš„ä¸šåŠ¡åœºæ™¯

## Fix Tearing & useSyncExternalStore

ç»å¤§å¤šæ•°ç±»åº“ä¸éœ€è¦åšä»»ä½•æ”¹åŠ¨å°±èƒ½å¤Ÿå…¼å®¹ React 18ï¼Œç„¶è€Œç”±äºå¹¶å‘æ¸²æŸ“çš„åŸå› ä½¿ç”¨éƒ¨åˆ†ç±»åº“ä¼šå¼•å‘ tearing çš„é—®é¢˜ï¼Œéœ€è¦è¿›è¡Œä¸€äº›å‡çº§æ‰èƒ½å…¼å®¹ã€‚

> Screen tearing is a visual artifact in video display where a display device shows information from multiple frames in a single screen draw - wiki

ç®€å•çš„è¯´ï¼Œå°±æ˜¯åœ¨å±å¹•ä¸Šçœ‹åˆ°äº†åŒä¸€ä¸ªç‰©ä½“çš„ä¸åŒå¸§çš„å½±åƒï¼Œç”»é¢ä»¿ä½›æ˜¯â€œæ’•è£‚çš„â€ï¼Œå¯¹åº”çš„ react ä¸­ï¼ŒæŒ‡ä½¿ç”¨äº†è¿‡å»ç‰ˆæœ¬çš„çŠ¶æ€è¿›è¡Œç”»é¢æ¸²æŸ“å¼•èµ·çš„ UI ä¸ä¸€è‡´æˆ–è€…å´©æºƒã€‚ç”±äº JS æ˜¯å•çº¿ç¨‹çš„ï¼Œå…¶å® web å¼€å‘ä¸­ä¸ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å¼•å…¥å¹¶å‘æ¸²æŸ“åï¼Œæ¸²æŸ“æ˜¯å¯èƒ½è¢«æ›´é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ä¸­æ–­ï¼Œè¿™ä¹Ÿä½¿å¾— tearing æˆä¸ºå¯èƒ½ã€‚ä½† React æœ¬èº«å¯¹äº state çš„æ›´æ–°åšäº†å¾ˆå¤šçš„å·¥ä½œæ¥é¿å…è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬çš„ä¾èµ–äº†å¤–éƒ¨çš„çŠ¶æ€ï¼ŒReact å°±æ— èƒ½ä¸ºåŠ›äº†ï¼Œå› ä¸ºå®ƒå¹¶ä¸çŸ¥é“ä½ ä»€ä¹ˆæ—¶å€™æ›´æ–°äº†å¤–éƒ¨çš„çŠ¶æ€ï¼Œçœ‹ä¸‹é¢çš„ä¾‹å­ï¼š

- åŒæ­¥æ¸²æŸ“

![åŒæ­¥æ¸²æŸ“](https://assets.ng-tech.icu/item/20230503153747.png)

- å¹¶å‘æ¸²æŸ“

![å¹¶å‘æ¸²æŸ“](https://assets.ng-tech.icu/item/20230503153823.png)

è¿™é‡Œ externalStore å°±æ˜¯æˆ‘ä»¬ä¾èµ–çš„ä¸€äº›å¤–éƒ¨çŠ¶æ€ï¼Œæ¯”å¦‚å¸¸è§çš„ reduxï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä½¿ç”¨ react-redux 7 çš„ä¾‹å­ï¼Œå¯ä»¥ç›´è§‚çš„æ„Ÿå—åˆ° tearing çš„å­˜åœ¨ã€‚å› æ­¤ 18 ä¸­ä¸“é—¨é’ˆå¯¹è¿™éƒ¨åˆ†ç±»åº“æä¾›ç›¸å…³çš„ API - useSyncExternalStoreï¼Œæ¯”å¦‚ react-redux 8.0.0 å®é™…ä¸Šå°±å·²ç»é›†æˆè¿›å»äº†ï¼Œå¤§å®¶å¯ä»¥æŠŠä¸Šé¢ demo ä¸­çš„ä¾èµ–æ”¹æˆè¿™ä¸ªç‰ˆæœ¬å†è¯•ä¸€ä¸‹ã€‚

å…·ä½“ç”¨æ³•çš„è¯ï¼Œè¿™è¾¹ç›´æ¥åšäº†ä¸€ä¸ª demoï¼Œä¸ºäº†ä½“ç°å…·ä½“çš„æ”¹åŠ¨ï¼Œå®ç°äº†ä¸€ä¸ª redux-likeï¼Œé‡ç‚¹å…³æ³¨ä¸¤ä¸ª useSelectorï¼Œçœ‹ä¸€ä¸‹[ä½¿ç”¨ä¸¤ä¸ªä¸åŒ selector çš„æ•ˆæœ](https://link.juejin.cn/?target=https%3A%2F%2Fcodesandbox.io%2Fs%2Fusesyncexternalstore-demo-671587)ã€‚

ç›¸ä¿¡å¤§å®¶åº”è¯¥å¯ä»¥æ„Ÿå—åˆ°åŒºåˆ«ï¼Œä¸è¿‡æˆ‘ä»¬çœ‹åˆ°è™½ç„¶ä½¿ç”¨äº† useSyncExternalStore é€šè¿‡æ¥å…¥ useSyncExternalStore å¯ä»¥è¾¾åˆ° ã€Œâœ… Make it rightã€çš„æ•ˆæœï¼Œä½†æ˜¯ä¹Ÿèƒ½æ„Ÿå—åˆ°è¦æ¯”æ²¡æœ‰ä½¿ç”¨ä¹‹å‰æ›´å¡äº†ï¼Œå¹¶æ²¡æœ‰è¾¾åˆ°ã€ŒğŸš€ Make it fastã€çš„æ•ˆæœï¼Œå…¶å®åŸå› è·Ÿè¿™ä¸ªæ–¹æ³•æœ¬èº«çš„å®ç°æœ‰å…³ï¼š

```js
function updateSyncExternalStore<T>(
  subscribe: (() => void) => () => void,

  getSnapshot: () => T,

  getServerSnapshot?: () => T
): T {
  const nextSnapshot = getSnapshot();

  const prevSnapshot = hook.memoizedState;

  const snapshotChanged = !is(prevSnapshot, nextSnapshot);

  // storeå†…å€¼æ›´æ–°æ—¶ï¼Œè¿›è¡Œä¸€è‡´æ€§æ£€æŸ¥

  updateEffect(subscribeToStore.bind(null, fiber, inst, subscribe), [
    subscribe,
  ]);

  // commitç¯å¢ƒå¼€å§‹ä¹‹å‰ï¼Œè¿›è¡Œä¸€æ¬¡ä¸€è‡´æ€§æ£€æŸ¥

  if (inst.getSnapshot !== getSnapshot || snapshotChanged) {
    pushEffect(
      HookHasEffect | HookPassive,

      updateStoreInstance.bind(null, fiber, inst, nextSnapshot, getSnapshot),

      undefined,

      null
    );
  }

  // renderç¯èŠ‚ç»“æŸæ—¶ï¼Œè¿›è¡Œä¸€æ¬¡ä¸€è‡´æ€§æ£€æŸ¥

  if (!includesBlockingLane(root, renderLanes)) {
    pushStoreConsistencyCheck(fiber, getSnapshot, nextSnapshot);
  }
}

// ...

// ä¸€è‡´æ€§æ£€æŸ¥æ–¹æ³•å†…

if (checkIfSnapshotChanged(inst)) {
  // Force a sync re-render.

  scheduleUpdateOnFiber(fiber, SyncLane, NoTimestamp);
}

// ...
```

å¯ä»¥çœ‹åˆ°ï¼Œå®ç°çš„æ ¸å¿ƒæ˜¯åŠ äº†ä¸‰é‡ä¿éšœæ¥è¿›è¡Œä¸€è‡´æ€§æ£€æŸ¥ï¼Œå½“å‡ºç°ä¸ä¸€è‡´æ—¶å°±å‘èµ·ä¸€ä¸ªåŒæ­¥æ›´æ–°çš„è°ƒåº¦ï¼Œå› æ­¤ transition çš„æ•ˆæœå°±å¤±çµäº†ï¼Œæ‰€ä»¥ä¼šé˜»å¡é¡µé¢äº¤äº’å‡ºç°äº†å¡é¡¿ã€‚å¯¹äºè¿™ä¸ªé—®é¢˜ React å›¢é˜Ÿè¿˜åœ¨ç ”ç©¶å’Œæ¢ç´¢ï¼Œä»ç„¶è¿˜æœ‰ä¸€æ®µè·¯è¦èµ°ã€‚

å¦å¤–å¯¹äºç±»åº“å¼€å‘è€…æ¥è¯´ï¼Œåœ¨ç¤¾åŒºå¹¶å‘ç‰¹æ€§å…¨é¢é“ºå¼€å‰ï¼Œä¸é¼“åŠ±åœ¨ç±»åº“ä¸­ä½¿ç”¨ Concurrent Featuresï¼Œå› ä¸ºè¿™ä¼šä½¿å¾—ä¾èµ–æˆ‘ä»¬ç±»åº“çš„ä¸Šå±‚åº”ç”¨é»˜è®¤å¼€å¯äº†å¹¶å‘æ¨¡å¼ï¼Œè€Œè¿™å¯èƒ½ä¸æ˜¯ä»–ä»¬æ‰€æœŸæœ›çš„ã€‚
